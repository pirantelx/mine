# Настройка системы с агентами

## Архитектура

Система состоит из:
- **Центральный сервер** - хранит всю информацию о майнерах, предоставляет веб-интерфейс
- **Агенты** - клиентские приложения, устанавливаются на каждой площадке, сканируют локальную сеть и отправляют данные на сервер

## Установка центрального сервера

1. Установите и запустите сервер как обычно (через Docker или локально)
2. При первом запуске автоматически создастся таблица `agents` в базе данных

## Регистрация агента

Перед установкой агента на площадке, его нужно зарегистрировать на сервере:

1. Войдите как администратор на центральный сервер
2. Зарегистрируйте агента через API:

```bash
curl -X POST "http://your-server:8000/api/agent/register" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -d '{
    "name": "site-1-agent",
    "description": "Агент на площадке 1",
    "site_id": 1
  }'
```

Ответ будет содержать `api_key` - сохраните его!

## Установка агента на площадке

1. Скопируйте папку `agent` на сервер площадки (должен иметь доступ к локальной сети майнеров)

2. Установите зависимости:
```bash
cd agent
pip install -r requirements.txt
```

3. Настройте конфигурацию:
```bash
cp config.json.example config.json
nano config.json
```

Укажите:
- `server_url` - URL центрального сервера (например, "http://192.168.1.100:8000")
- `api_key` - API ключ, полученный при регистрации
- `network_cidr` - CIDR сети для сканирования (например, "192.168.1.0/24")
- `scan_interval` - Интервал полного сканирования (секунды, по умолчанию 300)
- `poll_interval` - Интервал опроса майнеров (секунды, по умолчанию 60)

4. Запустите агента:
```bash
python agent.py
```

## Запуск как служба (systemd)

Создайте файл `/etc/systemd/system/miners-agent.service`:

```ini
[Unit]
Description=Miners Monitoring Agent
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/agent
Environment="AGENT_SERVER_URL=http://your-server:8000"
Environment="AGENT_API_KEY=your-api-key"
Environment="AGENT_NETWORK=192.168.1.0/24"
ExecStart=/usr/bin/python3 /path/to/agent/agent.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

Затем:
```bash
sudo systemctl enable miners-agent
sudo systemctl start miners-agent
sudo systemctl status miners-agent
```

## Как это работает

1. **Сканирование сети**: Агент периодически (каждые `scan_interval` секунд) сканирует указанную сеть для поиска новых майнеров
2. **Обнаружение майнеров**: При обнаружении майнера определяется его производитель и модель
3. **Сбор статистики**: Агент периодически (каждые `poll_interval` секунд) опрашивает все обнаруженные майнеры для получения статистики
4. **Отправка данных**: Все данные отправляются на центральный сервер через API `/api/agent/sync`

## API Endpoints для агентов

- `POST /api/agent/register` - Регистрация нового агента (только для администраторов)
- `POST /api/agent/sync` - Синхронизация данных от агента (требует API ключ)
- `GET /api/agent/info` - Получение информации об агенте (требует API ключ)

## Безопасность

- Агенты аутентифицируются через API ключи
- API ключи генерируются автоматически при регистрации и хранятся в базе данных
- Только администраторы могут регистрировать новых агентов
- Агенты могут только отправлять данные, не могут изменять или удалять информацию

## Устранение неполадок

1. **Агент не может подключиться к серверу**:
   - Проверьте, что сервер доступен с площадки
   - Проверьте правильность `server_url` в конфигурации
   - Проверьте файрвол

2. **Ошибка "Invalid or inactive API key"**:
   - Проверьте правильность API ключа
   - Убедитесь, что агент активен на сервере (проверьте через веб-интерфейс)

3. **Майнеры не обнаруживаются**:
   - Проверьте правильность `network_cidr`
   - Убедитесь, что агент имеет доступ к сети майнеров
   - Проверьте логи агента

4. **Статистика не собирается**:
   - Проверьте, что майнеры доступны по сети
   - Проверьте, что порт 4028 открыт
   - Проверьте логи агента для ошибок опроса
